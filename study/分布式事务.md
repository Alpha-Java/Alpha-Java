# 分布式事务

## 基本概念

### 事务

事务提供一种**机制**将一个活动涉及的多个操作纳入到一个不可分割的执行单元，组成事务的所有操作只有在所有操作均能正常执行的情况下方能**提交**，只要其中任一操作执行失败，都将导致整个事务的**回滚**。简单地说，事务提供一种“要么全部成功，要么全部失败（All or Nothing）”机制。

### 数据库本地事务

基于关系型数据库的事务称为本地事务。

数据库事务的四大特性：ACID

- A(Atomicity)

原子性：一个事务是最小的执行单元，事务中的所有操作，要么全部完成，要么全部不完成，不可能出现部分成功部分失败的情况。

就像你买东西要么交钱收货一起都执行，要么要是发不出货，就退钱。

- C(Consistency)

一致性：事务的一致性指的是在一个事务执行**之前**和执行**之后**数据库都必须处于一致性状态。

比如：张三向李四转100元，转账前和转账后的数据是正确状态这叫一致性，如果出现张三转出100元，李四账户没有增加100元这就出现了数据错误，就没有达到一致性。

- I(Isolation)

隔离性：数据库中的事务一般都是并发的，隔离性是指并发的两个事务的执行互不干扰，**一个事务不能看到其他事务运行过程的中间状态**。通过配置事务隔离级别可以避脏读、重复读等问问题

打个比方，你买东西这个事情，是不影响其他人的。

- D(Durability)

持久性：持久性，事务完成之后，该事务对数据的更改会被持久化到数据库。即使发生系统崩溃，重新启动数据库系统后，数据库还能恢复到事务成功结束时的状态。

打个比方，你买东西的时候需要记录在账本上，即使老板忘记了那也有据可查。

### InnoDB实现原理

本地事务由资源管理器进行管理

![image-20210407162057047](D:\Users\W9007568\AppData\Roaming\Typora\typora-user-images\image-20210407162057047.png)

![img](https://user-gold-cdn.xitu.io/2018/7/26/164d65b4f31b2356?imageslim)

而事务的ACID是通过InnoDB**日志和锁**来保证。

事务的隔离性是通过数据库锁的机制实现的。

持久性通过redo log（重做日志）来实现。

原子性和一致性通过Undo log来实现。Undo Log的原理很简单，为了满足事务的原子性，在操作任何数据之前，首先将数据备份到一个地方（这个存储数据备份的地方称为Undo Log）。然后进行数据的修改。如果出现了错误或者用户执行了ROLLBACK语句，系统可以利用Undo Log中的备份将数据恢复到事务开始之前的状态。 和Undo Log相反，Redo Log记录的是新数据的备份。在事务提交前，只要将Redo Log持久化即可，不需要将数据持久化。当系统崩溃时，虽然数据没有持久化，但是Redo Log已经持久化。系统可以根据Redo Log的内容，将所有数据恢复到最新的状态。 对具体实现过程有兴趣的同学可以去自行搜索扩展。





### 分布式事务

在分布式系统环境下由不同的服务之间通过网络协作完成的事务称之为分布式事务。创建订单扣减库存事务，用户注册送积分事务。

通过本地事务的思想来控制分布式系统事务是行不通的。

### 分布式事务产生的场景

- 跨JVM进程远程调用产生分布式事务
- 跨数据库实例产生分布式事务
- 总结：不能通过本地事务控制的场景

## 分布式事务基础理论

出现网络问题：数据不一致，服务不可用



### CAP理论

#### 理解CAP

一致性：写操作后的读操作读取到罪行的数据，不能返回旧数据。可以返回失败和新数据。

数据同步过程会对资源进行锁定，写操作会有一定延迟.

可用性：数据可以不一致，但是各个节点不能出现响应超时和响应错误。

分区容忍性：是分布式系统具备的基本能力，因为分布式系统难免出现网络问题。

其中一个节点挂掉不影响其他节点对外提供服务

数据同步失败不影响读写操作



用户查到旧数据用户是可以接受的。



X=









#### CAP组合方式

#### 总结

### BASE理论

基本可用 绝对可用

软状态 中间过度状态

最终一致性 经过一段时间 











XA方案的问题：

数据库支持2PC协议

第一阶段锁定资源，持有资源锁的时间较长，性能较差。



TM通知各个RM提交或回滚事务。Seata交给了TC通知。

TC：收集，存储，决策。

TM：开启全局事务，并最终先TC发起全局提交或全局回滚的指令。











